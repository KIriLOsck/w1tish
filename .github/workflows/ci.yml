name: FastAPI CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create .env file for CI
      run: |
        cat > .env << EOF
        JWT_SECRET=iWjwGUtt-DUeNb_QU8Oypc4jUZJX_FQflzpDzQTF9vA=
        EOF

    - name: Install Docker Compose
      run: |
        sudo curl -L "https://github.com/docker/compose/releases/download/v2.23.3/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
        docker-compose --version

    - name: Start services with Docker Compose
      run: |
        docker-compose up -d --build
        docker-compose ps
        
        until docker-compose exec database pg_isready -U admin; do
          sleep 5
        done

        until docker-compose exec messagebase mongosh --eval "db.runCommand('ping').ok" --quiet; do
          sleep 5
        done

        until docker-compose exec app curl -s -f http://localhost:80/health > /dev/null; do
          sleep 5
        done

    - name: Stop services
      if: always()
      run: docker-compose down -v